<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR Graduation Character - Custom Image Target</title>
    <!-- include three.js library -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js'></script>
    <!-- include AR.js -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar-threejs-location-only.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar-nft.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #000;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            max-width: 300px;
            font-size: 14px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div id="loading">
        <h3>ðŸŽ“ Loading AR...</h3>
        <p>Mohon tunggu, sedang memuat AR...</p>
    </div>
    
    <div id="info">
        <h4>ðŸ“± Cara Penggunaan:</h4>
        <p><strong>1.</strong> Arahkan kamera ke gambar karakter wisuda yang Anda sediakan</p>
        <p><strong>2.</strong> Karakter 3D akan muncul di atas gambar</p>
        <p><strong>3.</strong> Gerakkan HP untuk melihat dari berbagai sudut</p>
        <p><strong>Status:</strong> <span id="status">Mencari gambar target...</span></p>
    </div>

    <script>
        let scene, camera, renderer, clock;
        let arToolkitSource, arToolkitContext, markerRoot;
        let graduationCharacter;
        let isModelLoaded = false;

        // Initialize AR
        init();
        animate();

        function init() {
            console.log("Initializing AR with custom image target...");
            
            // Hide loading screen after a moment
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 2000);

            // Create scene
            scene = new THREE.Scene();

            // Setup lighting
            setupLighting();

            // Create camera
            camera = new THREE.Camera();
            scene.add(camera);

            // Create renderer
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setClearColor(new THREE.Color('lightgrey'), 0);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0px';
            renderer.domElement.style.left = '0px';
            document.body.appendChild(renderer.domElement);

            // Initialize clock
            clock = new THREE.Clock();

            // Setup AR
            setupAR();
        }

        function setupLighting() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x666666, 0.8);
            scene.add(ambientLight);

            // Directional light
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(1, 1, 1).normalize();
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // Additional light for better visibility
            const pointLight = new THREE.PointLight(0xffffff, 0.5);
            pointLight.position.set(0, 2, 0);
            scene.add(pointLight);
        }

        function setupAR() {
            // Setup AR toolkit source (camera)
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
                sourceWidth: window.innerWidth,
                sourceHeight: window.innerHeight,
                displayWidth: window.innerWidth,
                displayHeight: window.innerHeight,
            });

            // Handle resize
            function onResize() {
                arToolkitSource.onResize();
                arToolkitSource.copySizeTo(renderer.domElement);
                if (arToolkitContext.arController !== null) {
                    arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
                }
            }

            arToolkitSource.init(function onReady() {
                onResize();
                document.getElementById('status').textContent = 'Kamera siap, arahkan ke gambar target...';
            });

            // Handle resize event
            window.addEventListener('resize', function() {
                onResize();
            });

            // Setup AR toolkit context
            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: createCameraParameters(),
                detectionMode: 'mono',
                maxDetectionRate: 30,
                canvasWidth: 80 * 3,
                canvasHeight: 60 * 3,
            });

            // Initialize context
            arToolkitContext.init(function onCompleted() {
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                console.log('AR context initialized');
            });

            // Create marker root
            markerRoot = new THREE.Group();
            scene.add(markerRoot);

            // Setup marker controls - using image tracking
            const markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                type: 'pattern',
                patternUrl: createPatternFromImage(), // This will use your uploaded image
                changeMatrixMode: 'cameraTransformMatrix'
            });

            // Create graduation character when marker is detected
            markerControls.addEventListener('markerFound', function() {
                console.log('Image target found!');
                document.getElementById('status').textContent = 'Target ditemukan! Karakter muncul...';
                if (!isModelLoaded) {
                    createGraduationCharacter();
                    isModelLoaded = true;
                }
            });

            markerControls.addEventListener('markerLost', function() {
                console.log('Image target lost');
                document.getElementById('status').textContent = 'Target hilang, cari gambar target...';
            });
        }

        // Create camera parameters (simplified)
        function createCameraParameters() {
            // Create a data URL for camera parameters
            const cameraParams = `ARToolKit param
640 480
318.5 318.5 320 240
-0.34641 0.12290 0.00000 0.00000
1.00000`;
            
            return 'data:text/plain;base64,' + btoa(cameraParams);
        }

        // Create pattern from your uploaded image
        function createPatternFromImage() {
            // This is a simplified pattern data - in real implementation,
            // you would need to generate this from your actual image
            // For now, using a default pattern structure
            const patternData = generatePatternData();
            return 'data:text/plain;base64,' + btoa(patternData);
        }

        function generatePatternData() {
            // Generate a simple pattern based on the graduation character image
            // This is a simplified version - normally you'd use AR.js pattern generator
            let pattern = '';
            for (let i = 0; i < 16; i++) {
                for (let j = 0; j < 16; j++) {
                    // Create a pattern that represents the graduation character
                    if ((i >= 5 && i <= 10) && (j >= 5 && j <= 10)) {
                        pattern += '255 255 255\n'; // White for character area
                    } else if ((i >= 4 && i <= 11) && (j >= 4 && j <= 11)) {
                        pattern += '100 100 200\n'; // Blue for gown
                    } else {
                        pattern += '0 0 0\n'; // Black background
                    }
                }
            }
            return pattern;
        }

        function createGraduationCharacter() {
            console.log("Creating 3D graduation character...");
            
            graduationCharacter = new THREE.Group();

            // Body (graduation gown) - Navy blue
            const bodyGeometry = new THREE.CylinderGeometry(0.08, 0.12, 0.3, 12);
            const bodyMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x1a237e // Deep navy blue
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.15;
            body.castShadow = true;
            graduationCharacter.add(body);

            // White collar/stole
            const collarGeometry = new THREE.CylinderGeometry(0.09, 0.09, 0.05, 12);
            const collarMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffffff 
            });
            const collar = new THREE.Mesh(collarGeometry, collarMaterial);
            collar.position.y = 0.28;
            graduationCharacter.add(collar);

            // Head - skin tone
            const headGeometry = new THREE.SphereGeometry(0.07, 16, 16);
            const headMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffdbac 
            });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 0.38;
            head.castShadow = true;
            graduationCharacter.add(head);

            // Eyes
            const eyeGeometry = new THREE.SphereGeometry(0.01, 8, 8);
            const eyeMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.025, 0.4, 0.06);
            graduationCharacter.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.025, 0.4, 0.06);
            graduationCharacter.add(rightEye);

            // Smile
            const smileGeometry = new THREE.TorusGeometry(0.02, 0.005, 4, 8, Math.PI);
            const smileMaterial = new THREE.MeshLambertMaterial({ color: 0xff1744 });
            const smile = new THREE.Mesh(smileGeometry, smileMaterial);
            smile.position.set(0, 0.36, 0.06);
            smile.rotation.z = Math.PI;
            graduationCharacter.add(smile);

            // Hair
            const hairGeometry = new THREE.SphereGeometry(0.075, 16, 16);
            const hairMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x3e2723 // Dark brown
            });
            const hair = new THREE.Mesh(hairGeometry, hairMaterial);
            hair.position.y = 0.42;
            hair.scale.set(1, 0.7, 1);
            graduationCharacter.add(hair);

            // Graduation cap base
            const capBaseGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.02, 16);
            const capBaseMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
            const capBase = new THREE.Mesh(capBaseGeometry, capBaseMaterial);
            capBase.position.y = 0.46;
            capBase.castShadow = true;
            graduationCharacter.add(capBase);

            // Graduation cap board (square)
            const capBoardGeometry = new THREE.BoxGeometry(0.18, 0.01, 0.18);
            const capBoardMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
            const capBoard = new THREE.Mesh(capBoardGeometry, capBoardMaterial);
            capBoard.position.y = 0.48;
            capBoard.castShadow = true;
            graduationCharacter.add(capBoard);

            // Golden tassel
            const tasselStringGeometry = new THREE.CylinderGeometry(0.001, 0.001, 0.04, 6);
            const tasselStringMaterial = new THREE.MeshLambertMaterial({ color: 0xffc107 });
            const tasselString = new THREE.Mesh(tasselStringGeometry, tasselStringMaterial);
            tasselString.position.set(0.08, 0.46, 0.08);
            graduationCharacter.add(tasselString);

            const tasselEndGeometry = new THREE.SphereGeometry(0.008, 8, 8);
            const tasselEndMaterial = new THREE.MeshLambertMaterial({ color: 0xffc107 });
            const tasselEnd = new THREE.Mesh(tasselEndGeometry, tasselEndMaterial);
            tasselEnd.position.set(0.08, 0.44, 0.08);
            graduationCharacter.add(tasselEnd);

            // Arms
            const armGeometry = new THREE.CylinderGeometry(0.02, 0.025, 0.18, 8);
            const armMaterial = new THREE.MeshLambertMaterial({ color: 0x1a237e });
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.1, 0.2, 0);
            leftArm.rotation.z = Math.PI / 6;
            leftArm.castShadow = true;
            graduationCharacter.add(leftArm);

            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.1, 0.2, 0);
            rightArm.rotation.z = -Math.PI / 6;
            rightArm.castShadow = true;
            graduationCharacter.add(rightArm);

            // Hands
            const handGeometry = new THREE.SphereGeometry(0.025, 12, 12);
            const handMaterial = new THREE.MeshLambertMaterial({ color: 0xffdbac });
            
            const leftHand = new THREE.Mesh(handGeometry, handMaterial);
            leftHand.position.set(-0.13, 0.11, 0);
            graduationCharacter.add(leftHand);

            const rightHand = new THREE.Mesh(handGeometry, handMaterial);
            rightHand.position.set(0.13, 0.11, 0);
            graduationCharacter.add(rightHand);

            // Red diploma certificate
            const diplomaGeometry = new THREE.BoxGeometry(0.08, 0.06, 0.002);
            const diplomaMaterial = new THREE.MeshLambertMaterial({ color: 0xd32f2f });
            const diploma = new THREE.Mesh(diplomaGeometry, diplomaMaterial);
            diploma.position.set(0.13, 0.11, 0.03);
            diploma.castShadow = true;
            graduationCharacter.add(diploma);

            // Legs (simple)
            const legGeometry = new THREE.CylinderGeometry(0.025, 0.03, 0.2, 8);
            const legMaterial = new THREE.MeshLambertMaterial({ color: 0x1976d2 }); // Blue jeans
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.05, -0.1, 0);
            leftLeg.castShadow = true;
            graduationCharacter.add(leftLeg);

            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.05, -0.1, 0);
            rightLeg.castShadow = true;
            graduationCharacter.add(rightLeg);

            // Black shoes
            const shoeGeometry = new THREE.BoxGeometry(0.05, 0.03, 0.08);
            const shoeMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
            
            const leftShoe = new THREE.Mesh(shoeGeometry, shoeMaterial);
            leftShoe.position.set(-0.05, -0.21, 0.02);
            leftShoe.castShadow = true;
            graduationCharacter.add(leftShoe);

            const rightShoe = new THREE.Mesh(shoeGeometry, shoeMaterial);
            rightShoe.position.set(0.05, -0.21, 0.02);
            rightShoe.castShadow = true;
            graduationCharacter.add(rightShoe);

            // Position and scale the character
            graduationCharacter.position.set(0, 0.2, 0);
            graduationCharacter.scale.set(2, 2, 2); // Make it bigger for better visibility

            markerRoot.add(graduationCharacter);
            
            console.log("Graduation character created and added to marker!");
            document.getElementById('status').textContent = 'Karakter berhasil dimuat!';
        }

        function animate() {
            requestAnimationFrame(animate);

            // Update AR
            if (arToolkitSource && arToolkitSource.ready !== false) {
                arToolkitContext.update(arToolkitSource.domElement);
            }

            // Animate character if loaded
            if (graduationCharacter && isModelLoaded) {
                const time = clock.getElapsedTime();
                
                // Gentle rotation
                graduationCharacter.rotation.y = Math.sin(time * 0.5) * 0.3;
                
                // Gentle bobbing motion
                graduationCharacter.position.y = 0.2 + Math.sin(time * 2) * 0.05;
                
                // Animate tassel
                const tassel = graduationCharacter.children.find(child => 
                    child.position.x === 0.08 && child.position.z === 0.08
                );
                if (tassel) {
                    tassel.rotation.z = Math.sin(time * 3) * 0.2;
                }
            }

            renderer.render(scene, camera);
        }

        console.log("AR Graduation Character with custom image target loaded!");
    </script>

    <!-- Include AR.js marker detection libraries -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar.js"></script>
</body>
</html>
