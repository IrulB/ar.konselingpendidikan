<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR Graduation Character - Fixed</title>
    
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 999;
            max-width: 300px;
            font-size: 14px;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 1000;
        }
        
        .hidden {
            display: none !important;
        }

        #cameraButton {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }

        #cameraButton:hover {
            background: #1976D2;
        }
    </style>
</head>

<body>
    <div id="loading">
        <h3>🎓 Memuat AR...</h3>
        <p>Mohon tunggu sebentar...</p>
        <div style="margin-top: 15px;">
            <div style="width: 200px; height: 4px; background: #333; border-radius: 2px; overflow: hidden;">
                <div id="progressBar" style="width: 0%; height: 100%; background: #2196F3; transition: width 0.3s;"></div>
            </div>
        </div>
    </div>
    
    <div id="info" class="hidden">
        <h4>📱 Cara Penggunaan:</h4>
        <p><strong>1.</strong> Tekan tombol "Aktifkan Kamera"</p>
        <p><strong>2.</strong> Arahkan kamera ke marker Hiro (kotak hitam)</p>
        <p><strong>3.</strong> Karakter wisuda 3D akan muncul!</p>
        <p><strong>Status:</strong> <span id="status">Siap memulai AR</span></p>
    </div>

    <button id="cameraButton">🎥 Aktifkan Kamera</button>

    <!-- A-Frame AR Scene -->
    <a-scene
        id="arScene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        style="display: none;">
        
        <a-assets>
            <!-- Preload any assets here if needed -->
        </a-assets>

        <!-- Camera -->
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- Marker with Graduation Character -->
        <a-marker preset="hiro" id="hiroMarker">
            <!-- Graduation Character Group -->
            <a-entity id="graduationCharacter" position="0 0 0" scale="1 1 1">
                
                <!-- Body (Graduation Gown) -->
                <a-cylinder 
                    position="0 0.3 0" 
                    radius-top="0.15" 
                    radius-bottom="0.25" 
                    height="0.6" 
                    color="#1a237e"
                    shadow="cast: true">
                </a-cylinder>

                <!-- White Collar -->
                <a-cylinder 
                    position="0 0.55 0" 
                    radius="0.18" 
                    height="0.1" 
                    color="white">
                </a-cylinder>

                <!-- Head -->
                <a-sphere 
                    position="0 0.75 0" 
                    radius="0.14" 
                    color="#ffdbac"
                    shadow="cast: true">
                </a-sphere>

                <!-- Eyes -->
                <a-sphere 
                    position="-0.05 0.8 0.12" 
                    radius="0.02" 
                    color="black">
                </a-sphere>
                <a-sphere 
                    position="0.05 0.8 0.12" 
                    radius="0.02" 
                    color="black">
                </a-sphere>

                <!-- Smile -->
                <a-torus 
                    position="0 0.72 0.12" 
                    radius="0.04" 
                    radius-tubular="0.01" 
                    arc="180" 
                    color="#ff1744"
                    rotation="0 0 180">
                </a-torus>

                <!-- Hair -->
                <a-sphere 
                    position="0 0.82 0" 
                    radius="0.15" 
                    color="#3e2723"
                    scale="1 0.7 1">
                </a-sphere>

                <!-- Graduation Cap Base -->
                <a-cylinder 
                    position="0 0.9 0" 
                    radius="0.16" 
                    height="0.04" 
                    color="black"
                    shadow="cast: true">
                </a-cylinder>

                <!-- Graduation Cap Board -->
                <a-box 
                    position="0 0.93 0" 
                    width="0.36" 
                    height="0.02" 
                    depth="0.36" 
                    color="black"
                    shadow="cast: true">
                </a-box>

                <!-- Tassel -->
                <a-cylinder 
                    position="0.16 0.9 0.16" 
                    radius="0.005" 
                    height="0.08" 
                    color="#ffc107"
                    animation="property: rotation; to: 0 0 20; dur: 2000; dir: alternate; loop: true">
                </a-cylinder>
                <a-sphere 
                    position="0.16 0.86 0.16" 
                    radius="0.016" 
                    color="#ffc107">
                </a-sphere>

                <!-- Arms -->
                <a-cylinder 
                    position="-0.2 0.4 0" 
                    radius="0.04" 
                    height="0.36" 
                    color="#1a237e"
                    rotation="0 0 30"
                    shadow="cast: true">
                </a-cylinder>
                <a-cylinder 
                    position="0.2 0.4 0" 
                    radius="0.04" 
                    height="0.36" 
                    color="#1a237e"
                    rotation="0 0 -30"
                    shadow="cast: true">
                </a-cylinder>

                <!-- Hands -->
                <a-sphere 
                    position="-0.26 0.22 0" 
                    radius="0.05" 
                    color="#ffdbac">
                </a-sphere>
                <a-sphere 
                    position="0.26 0.22 0" 
                    radius="0.05" 
                    color="#ffdbac">
                </a-sphere>

                <!-- Diploma -->
                <a-box 
                    position="0.26 0.22 0.06" 
                    width="0.16" 
                    height="0.12" 
                    depth="0.004" 
                    color="#d32f2f"
                    shadow="cast: true">
                </a-box>

                <!-- Legs -->
                <a-cylinder 
                    position="-0.1 -0.2 0" 
                    radius="0.05" 
                    height="0.4" 
                    color="#1976d2"
                    shadow="cast: true">
                </a-cylinder>
                <a-cylinder 
                    position="0.1 -0.2 0" 
                    radius="0.05" 
                    height="0.4" 
                    color="#1976d2"
                    shadow="cast: true">
                </a-cylinder>

                <!-- Shoes -->
                <a-box 
                    position="-0.1 -0.42 0.04" 
                    width="0.1" 
                    height="0.06" 
                    depth="0.16" 
                    color="black"
                    shadow="cast: true">
                </a-box>
                <a-box 
                    position="0.1 -0.42 0.04" 
                    width="0.1" 
                    height="0.06" 
                    depth="0.16" 
                    color="black"
                    shadow="cast: true">
                </a-box>

                <!-- Animation for the whole character -->
                <a-animation
                    attribute="rotation"
                    to="0 360 0"
                    dur="8000"
                    repeat="indefinite">
                </a-animation>

                <!-- Bobbing animation -->
                <a-animation
                    attribute="position"
                    to="0 0.1 0"
                    dur="2000"
                    dir="alternate"
                    repeat="indefinite">
                </a-animation>

            </a-entity>
        </a-marker>

    </a-scene>

    <script>
        let arScene;
        let cameraActivated = false;
        let progressInterval;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            arScene = document.querySelector('#arScene');
            
            // Start progress bar
            startProgressBar();
            
            // Setup camera button
            document.getElementById('cameraButton').addEventListener('click', activateCamera);
            
            // Hide loading after 3 seconds
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('info').classList.remove('hidden');
                document.getElementById('status').textContent = 'Tekan tombol untuk memulai';
            }, 3000);
        });

        function startProgressBar() {
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            
            progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                }
                progressBar.style.width = progress + '%';
            }, 200);
        }

        function activateCamera() {
            if (cameraActivated) return;
            
            cameraActivated = true;
            const button = document.getElementById('cameraButton');
            const status = document.getElementById('status');
            
            button.textContent = '📹 Mengaktifkan...';
            button.disabled = true;
            status.textContent = 'Meminta izin kamera...';

            // Request camera permission
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(function(stream) {
                console.log('Camera permission granted');
                status.textContent = 'Kamera aktif, cari marker Hiro...';
                
                // Show AR scene
                arScene.style.display = 'block';
                
                // Hide button
                button.style.display = 'none';
                
                // Setup marker events
                setupMarkerEvents();
                
            })
            .catch(function(error) {
                console.error('Camera error:', error);
                status.textContent = 'Gagal mengakses kamera. Coba lagi.';
                button.textContent = '🎥 Coba Lagi';
                button.disabled = false;
                cameraActivated = false;
                
                if (error.name === 'NotAllowedError') {
                    status.textContent = 'Izin kamera ditolak. Refresh halaman dan coba lagi.';
                } else if (error.name === 'NotFoundError') {
                    status.textContent = 'Kamera tidak ditemukan.';
                }
            });
        }

        function setupMarkerEvents() {
            const marker = document.querySelector('#hiroMarker');
            const status = document.getElementById('status');
            
            marker.addEventListener('markerFound', function() {
                console.log('Marker found!');
                status.textContent = '🎉 Marker ditemukan! Karakter muncul!';
                status.style.background = 'rgba(76, 175, 80, 0.9)';
            });

            marker.addEventListener('markerLost', function() {
                console.log('Marker lost');
                status.textContent = '🔍 Cari marker Hiro (kotak hitam)...';
                status.style.background = 'rgba(0,0,0,0.8)';
            });
        }

        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                if (arScene && arScene.style.display !== 'none') {
                    location.reload();
                }
            }, 500);
        });

        console.log('AR Graduation Character - Fixed Version loaded!');
    </script>
</body>
</html>
