<!DOCTYPE html>
<html>
<head>
  <meta name="viewport"
        content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>AR.js + model.obj + materials.mtl</title>

  <!-- Three.js -->
  <script src="js/three.js"></script>
  <script src="js/OBJLoader.js"></script>
  <script src="js/MTLLoader.js"></script>

  <!-- jsartoolkit5 -->
  <script src="jsartoolkit5/artoolkit.min.js"></script>
  <script src="jsartoolkit5/artoolkit.api.js"></script>

  <!-- threex -->
  <script src="threex/threex-artoolkitsource.js"></script>
  <script src="threex/threex-artoolkitcontext.js"></script>
  <script src="threex/threex-arbasecontrols.js"></script>
  <script src="threex/threex-armarkercontrols.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: Monospace; }
  </style>
</head>
<body>
<script>
  let scene, camera, renderer, clock, deltaTime, totalTime;
  let arToolkitSource, arToolkitContext;
  let markerRoot;

  initialize();
  animate();

  function initialize() {
    scene = new THREE.Scene();
    scene.add(new THREE.AmbientLight(0xcccccc, 1.0));

    camera = new THREE.Camera();
    scene.add(camera);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setClearColor(new THREE.Color('lightgrey'), 0);
    renderer.setSize(640, 480);
    renderer.domElement.style.position = 'absolute';
    renderer.domElement.style.top = '0px';
    renderer.domElement.style.left = '0px';
    document.body.appendChild(renderer.domElement);

    clock = new THREE.Clock();
    deltaTime = 0;
    totalTime = 0;

    /* ------------------------------------------------------------ */
    /* 1. AR Toolkit Source                                         */
    /* ------------------------------------------------------------ */
    arToolkitSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
    arToolkitSource.init(onReady);

    function onReady() { onResize(); }
    window.addEventListener('resize', onResize);

    function onResize() {
      arToolkitSource.onResize();
      arToolkitSource.copySizeTo(renderer.domElement);
      if (arToolkitContext.arController)
        arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
    }

    /* ------------------------------------------------------------ */
    /* 2. AR Toolkit Context                                        */
    /* ------------------------------------------------------------ */
    arToolkitContext = new THREEx.ArToolkitContext({
      cameraParametersUrl: 'data/camera_para.dat',
      detectionMode: 'mono'
    });
    arToolkitContext.init(() => {
      camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    /* ------------------------------------------------------------ */
    /* 3. Marker Root                                               */
    /* ------------------------------------------------------------ */
    markerRoot = new THREE.Group();
    scene.add(markerRoot);

    new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
      type: 'pattern',
      patternUrl: 'data/hiro.patt'
    });

    /* ------------------------------------------------------------ */
    /* 4. Load model.obj + materials.mtl                            */
    /* ------------------------------------------------------------ */
    const onProgress = xhr =>
      console.log((xhr.loaded / xhr.total * 100) + '% loaded');
    const onError = err => console.error(err);

    new THREE.MTLLoader()
      .setPath('models/')
      .load('materials.mtl',
        materials => {
          materials.preload();
          new THREE.OBJLoader()
            .setMaterials(materials)
            .setPath('models/')
            .load('model.obj',
              object => {
                /* Sesuaikan skala & posisi sesuai kebutuhan Anda */
                object.scale.set(0.2, 0.2, 0.2);
                object.position.y = 0.2;
                markerRoot.add(object);
              },
              onProgress,
              onError
            );
        },
        onProgress,
        onError
      );
  }

  function update() {
    if (arToolkitSource.ready !== false)
      arToolkitContext.update(arToolkitSource.domElement);
  }

  function render() { renderer.render(scene, camera); }

  function animate() {
    requestAnimationFrame(animate);
    deltaTime = clock.getDelta();
    totalTime += deltaTime;
    update();
    render();
  }
</script>
</body>
</html>
