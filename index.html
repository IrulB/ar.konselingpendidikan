<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>AR Graduation Character - Custom Image Target</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for NFT (Natural Feature Tracking) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 999;
            font-size: 14px;
            text-align: center;
        }
        
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 10px;
            right: 10px;
            color: white;
            background: rgba(33, 150, 243, 0.9);
            padding: 15px;
            border-radius: 10px;
            z-index: 999;
            font-size: 14px;
            text-align: center;
        }

        #uploadArea {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
            z-index: 1000;
            text-align: center;
            color: white;
            max-width: 90%;
        }

        #fileInput {
            margin: 20px 0;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #startAR {
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .hidden {
            display: none !important;
        }

        .status-found {
            background: rgba(76, 175, 80, 0.9) !important;
        }

        .status-lost {
            background: rgba(244, 67, 54, 0.9) !important;
        }

        #targetPreview {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #2196F3;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div id="uploadArea">
        <h3>üéì Setup AR Target</h3>
        <p>Upload gambar karakter wisuda atau gunakan gambar default</p>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        <button onclick="document.getElementById('fileInput').click()">üìÅ Pilih Gambar</button>
        <br>
        <img id="targetPreview" class="hidden" alt="Target Preview">
        <br>
        <button id="startAR" onclick="startAR()">üöÄ Mulai AR</button>
        <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
            * Gambar akan digunakan sebagai target AR
        </div>
    </div>

    <div id="info" class="hidden">
        <div><strong>üéì AR Karakter Wisuda</strong></div>
        <div id="status">Memuat AR... Mohon tunggu</div>
    </div>

    <div id="instructions" class="hidden">
        <strong>üìã Instruksi:</strong><br>
        1. Arahkan kamera ke gambar target<br>
        2. Pastikan pencahayaan cukup<br>
        3. Jaga jarak 20-50cm dari gambar<br>
        4. Karakter 3D akan muncul di atas gambar
    </div>

    <!-- A-Frame AR Scene -->
    <a-scene
        id="arScene"
        class="hidden"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best; maxDetectionRate: 30; canvasWidth: 640; canvasHeight: 480;"
        vr-mode-ui="enabled: false;"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; antialias: true;"
        device-orientation-permission-ui="enabled: false">

        <!-- Camera -->
        <a-entity camera></a-entity>

        <!-- Custom Image Marker -->
        <a-marker 
            id="imageMarker"
            type="pattern" 
            url="data:text/plain;charset=utf-8;base64,"
            smooth="true" 
            smoothCount="10" 
            smoothTolerance=".01" 
            smoothThreshold="5">
            
            <!-- Graduation Character -->
            <a-entity id="graduationChar" position="0 0.5 0" scale="1.2 1.2 1.2">
                
                <!-- Body (Graduation Gown) - Dark Blue -->
                <a-cylinder 
                    position="0 0 0" 
                    radius-top="0.15" 
                    radius-bottom="0.25" 
                    height="0.6" 
                    color="#1a237e"
                    material="roughness: 0.7; metalness: 0.1"
                    shadow="cast: true">
                </a-cylinder>

                <!-- White Collar/Stole -->
                <a-ring 
                    position="0 0.25 0" 
                    radius-inner="0.12" 
                    radius-outer="0.18" 
                    color="white"
                    rotation="-90 0 0">
                </a-ring>

                <!-- Head - Skin Color -->
                <a-sphere 
                    position="0 0.45 0" 
                    radius="0.12" 
                    color="#ffdbac"
                    material="roughness: 0.8"
                    shadow="cast: true">
                </a-sphere>

                <!-- Eyes -->
                <a-sphere position="-0.04 0.48 0.1" radius="0.015" color="#000"></a-sphere>
                <a-sphere position="0.04 0.48 0.1" radius="0.015" color="#000"></a-sphere>

                <!-- Eye pupils with shine -->
                <a-sphere position="-0.04 0.485 0.11" radius="0.008" color="#333"></a-sphere>
                <a-sphere position="0.04 0.485 0.11" radius="0.008" color="#333"></a-sphere>
                <a-sphere position="-0.038 0.488 0.112" radius="0.003" color="white"></a-sphere>
                <a-sphere position="0.042 0.488 0.112" radius="0.003" color="white"></a-sphere>

                <!-- Nose -->
                <a-sphere position="0 0.45 0.11" radius="0.008" color="#e6a378"></a-sphere>

                <!-- Smile -->
                <a-torus 
                    position="0 0.42 0.1" 
                    radius="0.025" 
                    radius-tubular="0.004" 
                    arc="180" 
                    color="#ff5722"
                    rotation="0 0 180">
                </a-torus>

                <!-- Hair - Dark Brown -->
                <a-sphere 
                    position="0 0.52 -0.02" 
                    radius="0.13" 
                    color="#3e2723"
                    scale="1 0.8 0.9">
                </a-sphere>

                <!-- Graduation Cap Base -->
                <a-cylinder 
                    position="0 0.58 0" 
                    radius="0.13" 
                    height="0.03" 
                    color="#000"
                    material="roughness: 0.9"
                    shadow="cast: true">
                </a-cylinder>

                <!-- Graduation Cap Board (Square Top) -->
                <a-box 
                    position="0 0.61 0" 
                    width="0.3" 
                    height="0.02" 
                    depth="0.3" 
                    color="#000"
                    material="roughness: 0.9"
                    shadow="cast: true">
                </a-box>

                <!-- Tassel String -->
                <a-cylinder 
                    position="0.12 0.6 0.12" 
                    radius="0.003" 
                    height="0.06" 
                    color="#ffc107">
                </a-cylinder>

                <!-- Tassel End -->
                <a-sphere 
                    position="0.12 0.57 0.12" 
                    radius="0.015" 
                    color="#ffc107"
                    animation="property: rotation; to: 360 0 0; dur: 4000; loop: true">
                </a-sphere>

                <!-- Left Arm -->
                <a-cylinder 
                    position="-0.18 0.1 0" 
                    radius="0.035" 
                    height="0.3" 
                    color="#1a237e"
                    rotation="0 0 25"
                    shadow="cast: true">
                </a-cylinder>

                <!-- Right Arm -->
                <a-cylinder 
                    position="0.18 0.1 0" 
                    radius="0.035" 
                    height="0.3" 
                    color="#1a237e"
                    rotation="0 0 -25"
                    shadow="cast: true">
                </a-cylinder>

                <!-- Left Hand -->
                <a-sphere 
                    position="-0.22 -0.05 0" 
                    radius="0.04" 
                    color="#ffdbac">
                </a-sphere>

                <!-- Right Hand -->
                <a-sphere 
                    position="0.22 -0.05 0" 
                    radius="0.04" 
                    color="#ffdbac">
                </a-sphere>

                <!-- Diploma Certificate -->
                <a-box 
                    position="0.25 -0.05 0.05" 
                    width="0.12" 
                    height="0.08" 
                    depth="0.003" 
                    color="#d32f2f"
                    material="roughness: 0.6"
                    shadow="cast: true">
                </a-box>

                <!-- Diploma ribbon -->
                <a-cylinder 
                    position="0.25 -0.05 0.052" 
                    radius="0.002" 
                    height="0.08" 
                    color="#ffc107"
                    rotation="90 0 0">
                </a-cylinder>

                <!-- Legs -->
                <a-cylinder 
                    position="-0.08 -0.35 0" 
                    radius="0.04" 
                    height="0.3" 
                    color="#1976d2"
                    shadow="cast: true">
                </a-cylinder>
                <a-cylinder 
                    position="0.08 -0.35 0" 
                    radius="0.04" 
                    height="0.3" 
                    color="#1976d2"
                    shadow="cast: true">
                </a-cylinder>

                <!-- Shoes -->
                <a-box 
                    position="-0.08 -0.52 0.03" 
                    width="0.08" 
                    height="0.04" 
                    depth="0.12" 
                    color="#000"
                    shadow="cast: true">
                </a-box>
                <a-box 
                    position="0.08 -0.52 0.03" 
                    width="0.08" 
                    height="0.04" 
                    depth="0.12" 
                    color="#000"
                    shadow="cast: true">
                </a-box>

                <!-- Main Character Animation - Gentle Rotation -->
                <a-animation
                    attribute="rotation"
                    to="0 360 0"
                    dur="12000"
                    repeat="indefinite">
                </a-animation>

                <!-- Bobbing Animation -->
                <a-animation
                    attribute="position"
                    to="0 0.6 0"
                    dur="3000"
                    direction="alternate"
                    repeat="indefinite">
                </a-animation>

            </a-entity>

            <!-- Congratulations Text -->
            <a-text 
                value="SELAMAT WISUDA!"
                position="0 1.4 0"
                align="center"
                color="#FFD700"
                scale="0.6 0.6 0.6"
                material="shader: msdf; font: roboto"
                animation="property: rotation; to: 0 360 0; dur: 8000; loop: true">
            </a-text>

            <!-- Celebration Particles -->
            <a-sphere position="-0.4 1.2 0.3" radius="0.02" color="#ffeb3b"
                animation="property: position; to: -0.4 1.8 0.3; dur: 2000; dir: alternate; loop: true"></a-sphere>
            <a-sphere position="0.4 1.2 0.3" radius="0.02" color="#ff9800"
                animation="property: position; to: 0.4 1.8 0.3; dur: 2500; dir: alternate; loop: true"></a-sphere>
            <a-sphere position="0 1.2 -0.4" radius="0.02" color="#e91e63"
                animation="property: position; to: 0 1.8 -0.4; dur: 3000; dir: alternate; loop: true"></a-sphere>
            <a-sphere position="-0.3 1.3 -0.2" radius="0.015" color="#9c27b0"
                animation="property: position; to: -0.3 1.7 -0.2; dur: 2200; dir: alternate; loop: true"></a-sphere>
            <a-sphere position="0.3 1.3 -0.2" radius="0.015" color="#2196f3"
                animation="property: position; to: 0.3 1.7 -0.2; dur: 2800; dir: alternate; loop: true"></a-sphere>

            <!-- Ground shadow -->
            <a-plane 
                position="0 -0.5 0" 
                width="2" 
                height="2" 
                color="#000" 
                opacity="0.3" 
                rotation="-90 0 0">
            </a-plane>

        </a-marker>

    </a-scene>

    <script>
        let targetImageData = null;
        let arStarted = false;

        // Handle file upload
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.getElementById('targetPreview');
                    img.src = event.target.result;
                    img.classList.remove('hidden');
                    targetImageData = event.target.result;
                    
                    // Generate pattern from image
                    generatePatternFromImage(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        function generatePatternFromImage(imageData) {
            // Create a canvas to process the image
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Set canvas size to 16x16 for pattern generation
                canvas.width = 16;
                canvas.height = 16;
                
                // Draw scaled image to canvas
                ctx.drawImage(img, 0, 0, 16, 16);
                
                // Get image data
                const imageData = ctx.getImageData(0, 0, 16, 16);
                const data = imageData.data;
                
                // Generate pattern data
                let pattern = '';
                for (let i = 0; i < 16; i++) {
                    for (let j = 0; j < 16; j++) {
                        const index = (i * 16 + j) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        
                        // Convert to grayscale and create pattern
                        const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                        
                        if (gray > 128) {
                            pattern += '255 255 255\n';
                        } else if (gray > 64) {
                            pattern += '128 128 128\n';
                        } else {
                            pattern += '0 0 0\n';
                        }
                    }
                }
                
                // Update marker with new pattern
                const marker = document.getElementById('imageMarker');
                const patternData = btoa(pattern);
                marker.setAttribute('url', 'data:text/plain;charset=utf-8;base64,' + patternData);
                
                console.log('Pattern generated from uploaded image');
            };
            
            img.src = imageData;
        }

        function startAR() {
            if (arStarted) return;
            
            // Use default graduation character image if no image uploaded
            if (!targetImageData) {
                // Generate a default pattern for graduation character
                generateDefaultPattern();
            }
            
            arStarted = true;
            
            // Hide upload area and show AR
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('arScene').classList.remove('hidden');
            document.getElementById('info').classList.remove('hidden');
            document.getElementById('instructions').classList.remove('hidden');
            
            // Initialize AR scene
            initializeAR();
        }

        function generateDefaultPattern() {
            // Generate a simple pattern based on the graduation character colors
            let pattern = '';
            for (let i = 0; i < 16; i++) {
                for (let j = 0; j < 16; j++) {
                    // Create a recognizable pattern
                    if ((i >= 2 && i <= 13) && (j >= 2 && j <= 13)) {
                        if ((i >= 4 && i <= 11) && (j >= 4 && j <= 11)) {
                            if ((i >= 6 && i <= 9) && (j >= 6 && j <= 9)) {
                                pattern += '26 35 126\n'; // Navy blue (graduation gown)
                            } else {
                                pattern += '255 255 255\n'; // White (collar)
                            }
                        } else {
                            pattern += '255 219 172\n'; // Skin color
                        }
                    } else {
                        pattern += '0 0 0\n'; // Black background
                    }
                }
            }
            
            const marker = document.getElementById('imageMarker');
            const patternData = btoa(pattern);
            marker.setAttribute('url', 'data:text/plain;charset=utf-8;base64,' + patternData);
        }

        function initializeAR() {
            const scene = document.querySelector('a-scene');
            const marker = document.getElementById('imageMarker');
            const status = document.getElementById('status');
            const info = document.getElementById('info');

            // Scene loaded
            scene.addEventListener('loaded', function() {
                console.log('A-Frame scene loaded');
                status.textContent = 'AR siap! Arahkan ke gambar target...';
            });

            // Marker found
            marker.addEventListener('markerFound', function() {
                console.log('Image target ditemukan!');
                status.textContent = 'üéâ Target ditemukan! Selamat wisuda!';
                info.className = 'status-found';
                
                // Celebration effect
                try {
                    // Simple celebration sound
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBkPE7OEAAA==');
                    audio.volume = 0.3;
                    audio.play().catch(() => {});
                } catch(e) {}
            });

            // Marker lost
            marker.addEventListener('markerLost', function() {
                console.log('Image target hilang');
                status.textContent = 'Target hilang. Cari lagi gambar target...';
                info.className = 'status-lost';
            });

            // Camera ready
            scene.addEventListener('camera-init', function() {
                console.log('Kamera berhasil diinisialisasi');
                status.textContent = 'Kamera aktif! Cari target gambar...';
            });

            console.log('AR dengan custom image target initialized');
        }

        // Auto-start with default pattern after 3 seconds if no image uploaded
        setTimeout(() => {
            if (!arStarted && !targetImageData) {
                document.querySelector('#uploadArea h3').textContent = 'üéì AR Siap Dimulai!';
                document.querySelector('#uploadArea p').textContent = 'Menggunakan target default karakter wisuda';
            }
        }, 3000);
    </script>

</body>
</html>
